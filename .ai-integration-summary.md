# AI Service Integration in ExternalCredentialSyncScheduler

## Overview
Successfully integrated AI analysis layers (`/stackability` and `/generate-roadmap`) into the External Credential Sync flow. Both AI services are called **asynchronously** after credential creation, IPFS upload, and blockchain queuing.

## Flow Architecture

### Current Flow (Enhanced)
```
1. ExternalCredentialSyncScheduler.runSyncJob()
   ↓
2. externalCredentialSyncService.syncAll()
   ↓
3. For each provider:
   - Authenticate with external provider (dummy-server)
   - Fetch credentials since last sync
   ↓
4. For each credential:
   - Normalize to canonical format
   - Download PDF from external provider
   - Upload PDF to IPFS (Filebase)
   - Generate data hash
   - Create credential in database
   - Queue blockchain write
   ↓
5. [NEW] AI Analysis Layer (Async - Non-blocking):
   - Call ai_groq_service/stackability (parallel)
   - Call ai_groq_service/generate-roadmap (parallel)
   - Update credential metadata with results
```

## Changes Made

### 1. AIService Enhancement (`server/node-app/src/modules/ai/ai.service.ts`)

Added two new methods:

#### `analyzeStackability()`
- **Endpoint**: `POST http://127.0.0.1:8000/stackability`
- **Purpose**: Analyze progression pathways and stackable credentials
- **Input**: Qualification details (code, NSQF level, sector, hours, occupation, skills)
- **Output**: List of career pathways with skill breakdowns and completion status
- **Error Handling**: Returns empty pathways on error (non-blocking)

#### `generatePathway()`
- **Endpoint**: `POST http://127.0.0.1:8000/generate-roadmap`
- **Purpose**: Generate career roadmap/pathway recommendations
- **Input**: Certificate data and learner profile
- **Output**: Career roadmap with learning stages and recommendations
- **Error Handling**: Returns null on error (non-blocking)

### 2. ExternalCredentialSyncService Enhancement (`server/node-app/src/modules/external-credential-sync/service.ts`)

#### New Method: `processAIAnalysisAsync()`
This private method is called asynchronously after credential creation:

**Process:**
1. Prepares certificate data for AI analysis
2. Runs **both AI calls in parallel** using `Promise.allSettled()`
   - Stackability analysis
   - Pathway generation
3. Processes results (handles both fulfilled and rejected promises)
4. Updates credential metadata with AI analysis results

**Key Features:**
- ✅ Non-blocking: Doesn't delay credential creation
- ✅ Parallel execution: Both AI calls run simultaneously
- ✅ Fault-tolerant: Errors in AI analysis don't affect credential sync
- ✅ Logged: All steps are logged for debugging

#### Integration Point
The AI analysis is triggered in `createCredential()` after the blockchain write:

```typescript
// AI Analysis Layer: Run stackability and pathway analysis asynchronously
this.processAIAnalysisAsync(credentialId, canonical, metadata).catch(error => {
    logger.error(`AI analysis failed for ${credentialId}`, { error: error.message });
    // Don't block credential creation if AI analysis fails
});
```

## Data Flow Examples

### Input to Stackability Service
```json
{
  "code": "SSC/Q1402",
  "level": 4,
  "progression_pathway": "Digital Marketing Professional certification",
  "qualification_type": "udemy",
  "sector_name": "Marketing",
  "training_delivery_hours": "120 hours",
  "min_notational_hours": 100,
  "max_notational_hours": 150,
  "proposed_occupation": "Digital Marketing Specialist",
  "skills": []
}
```

### Output from Stackability Service
```json
{
  "pathways": [
    {
      "pathway_title": "Digital Marketing Manager - NSQF Level 6",
      "progress_percentage": 50,
      "skills": [
        { "name": "SEO", "credits_earned": 2, "credits_total": 2, "status": "completed" },
        { "name": "Google Analytics", "credits_earned": 0, "credits_total": 4, "status": "missing" }
      ]
    }
  ]
}
```

### Updated Credential Metadata
After AI analysis, the credential metadata is updated with:
```json
{
  "ai_analysis": {
    "stackability": { /* stackability results */ },
    "pathway": { /* roadmap results */ }
  },
  "ai_analysis_completed_at": "2025-12-09T10:30:00.000Z"
}
```

## Benefits

1. **Enhanced Credential Value**: External credentials now have AI-generated insights
2. **Career Guidance**: Learners get automatic pathway recommendations
3. **Skill Gap Analysis**: Stackability shows what skills are missing for progression
4. **Non-intrusive**: AI analysis doesn't slow down credential sync
5. **Resilient**: Failures in AI analysis don't affect credential creation

## Testing Recommendations

### 1. Test AI Service Availability
```bash
curl http://127.0.0.1:8000/health
```

### 2. Test Stackability Endpoint
```bash
curl -X POST http://127.0.0.1:8000/stackability \
  -H "Content-Type: application/json" \
  -d '{
    "code": "SSC/Q1402",
    "level": 4,
    "sector_name": "IT",
    "skills": ["Python", "JavaScript"]
  }'
```

### 3. Test Pathway Endpoint
```bash
curl -X POST http://127.0.0.1:8000/generate-roadmap \
  -H "Content-Type: application/json" \
  -d '{
    "certificates": [{"certificate_title": "AWS Certified Developer"}],
    "learner_profile": {}
  }'
```

### 4. Trigger External Credential Sync
Use the admin dashboard to force a sync, or wait for the scheduled sync.

### 5. Verify Metadata Update
Check the credential in the database to confirm `ai_analysis` field is populated.

## Monitoring

Check logs for:
- `Starting AI analysis for credential {id}`
- `Stackability analysis completed for {id}`
- `Pathway generation completed for {id}`
- `AI analysis results saved to credential {id}`

## Environment Variables Required

Ensure these are set in `.env`:
```
AI_SERVICE_URL=http://127.0.0.1:8000
```

## Routes Used

From `server/ai_groq_service`:
- ✅ `POST /stackability` - Stackability analysis
- ✅ `POST /generate-roadmap` - Career pathway generation

## Notes

- Both AI calls are **asynchronous** and run **in parallel**
- The integration is **fault-tolerant** - credential creation continues even if AI fails
- Results are stored in `credential.metadata.ai_analysis`
- Timestamp of analysis is stored in `credential.metadata.ai_analysis_completed_at`
