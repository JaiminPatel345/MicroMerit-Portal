openapi: 3.0.3
info:
  title: MicroMerit Portal - Credential Issuance API
  description: |
    API for issuing blockchain-backed verifiable credentials.
    
    ## Workflow
    1. Issuer authenticates (via JWT or API key)
    2. Issuer provides learner_email, certificate details, and PDF
    3. System resolves learner (by email or other_emails array)
    4. If learner not found â†’ credential marked as "unclaimed"
    5. System uploads PDF to IPFS (Filebase)
    6. System writes to blockchain (mock)
    7. System stores credential in database
    
    ## Features
    - Learner email resolution (primary + other_emails)
    - Unclaimed credentials for future learners
    - IPFS pinning via Filebase
    - Blockchain integration (mock mode available)
    - Canonical JSON generation with SHA256 hash
    
  version: 1.0.0
  contact:
    name: MicroMerit Portal Team
    email: support@micromerit.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.micromerit.com/api
    description: Production server

tags:
  - name: Credential Issuance
    description: Issue verifiable credentials

paths:
  /credentials/issue:
    post:
      tags: [Credential Issuance]
      summary: Issue a new credential
      description: |
        Issue a blockchain-backed verifiable credential for a learner.
        
        **Authentication**: Requires issuer JWT token OR API key
        - JWT: Add `Authorization: Bearer <token>` header
        - API Key: Add `X-API-Key: <your-api-key>` header
        
        **Learner Resolution**:
        - Searches by `learner_email` in learners table
        - If not found, searches in `other_emails` array
        - If still not found, creates "unclaimed" credential
        
        **PDF Upload**:
        - Field name: `original_pdf`
        - Accepts PDF files only
        - Max size: 10MB
        - Uploaded to IPFS via Filebase
        
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - learner_email
                - issuer_id
                - certificate_title
                - original_pdf
              properties:
                learner_email:
                  type: string
                  format: email
                  example: learner@example.com
                  description: Email of the learner (system will resolve to learner_id)
                issuer_id:
                  type: integer
                  example: 1
                  description: ID of the issuer (must be approved)
                certificate_title:
                  type: string
                  maxLength: 500
                  example: "Certificate of Completion - Web Development Course"
                  description: Title of the certificate
                issued_at:
                  type: string
                  format: date-time
                  example: "2024-01-15T10:00:00Z"
                  description: Date and time when certificate was issued (defaults to now)
                original_pdf:
                  type: string
                  format: binary
                  description: |
                    Original PDF certificate (1 page)
                    - Max size: 10MB
                    - Will be uploaded to IPFS
            encoding:
              original_pdf:
                contentType: application/pdf
      
      responses:
        '201':
          description: Credential issued successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credential issued successfully
                  data:
                    $ref: '#/components/schemas/IssuedCredential'
              example:
                success: true
                message: Credential issued successfully
                data:
                  credential_id: "123e4567-e89b-12d3-a456-426614174000"
                  learner_id: 42
                  learner_email: "learner@example.com"
                  certificate_title: "Certificate of Completion - Web Development Course"
                  ipfs_cid: "QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
                  tx_hash: "0x123e4567e89b12d3a456426614174000"
                  data_hash: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
                  pdf_url: "https://ipfs.filebase.io/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
                  status: "issued"
                  issued_at: "2024-01-15T10:00:00.000Z"
        
        '400':
          description: Validation error or file upload error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_file:
                  summary: PDF file not provided
                  value:
                    success: false
                    message: Missing original_pdf file
                    error: PDF file is required
                    statusCode: 400
                invalid_file_type:
                  summary: Non-PDF file uploaded
                  value:
                    success: false
                    message: Only PDF files are allowed
                    error: INVALID_FILE_TYPE
                    statusCode: 400
                validation_error:
                  summary: Invalid input data
                  value:
                    success: false
                    message: Validation failed
                    error: Invalid email format
                    statusCode: 400
        
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Access token is required
                error: UNAUTHORIZED
                statusCode: 401
        
        '403':
          description: Issuer not approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Issuer is not approved to issue credentials
                error: ISSUER_NOT_APPROVED
                statusCode: 403
        
        '404':
          description: Issuer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Issuer not found
                error: ISSUER_NOT_FOUND
                statusCode: 404
        
        '500':
          description: Server error (IPFS upload failed, blockchain error, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Failed to issue credential
                error: Internal server error
                statusCode: 500

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token for issuer authentication
    
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for programmatic access

  schemas:
    IssuedCredential:
      type: object
      properties:
        credential_id:
          type: string
          format: uuid
          description: Unique credential identifier
        learner_id:
          type: integer
          nullable: true
          description: ID of the learner (null for unclaimed credentials)
        learner_email:
          type: string
          format: email
          description: Email of the learner
        certificate_title:
          type: string
          description: Title of the certificate
        ipfs_cid:
          type: string
          description: IPFS CID of the uploaded PDF
        tx_hash:
          type: string
          description: Blockchain transaction hash
        data_hash:
          type: string
          description: SHA256 hash of the canonical JSON
        pdf_url:
          type: string
          format: uri
          description: IPFS gateway URL for the PDF
        status:
          type: string
          enum: [issued, unclaimed, claimed, revoked]
          description: Status of the credential
        issued_at:
          type: string
          format: date-time
          description: Timestamp when credential was issued
    
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
        statusCode:
          type: integer
