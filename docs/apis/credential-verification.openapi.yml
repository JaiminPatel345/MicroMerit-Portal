openapi: 3.0.3
info:
  title: MicroMerit Portal - Credential Verification API
  description: |
    API for verifying blockchain-backed credentials.
    
    ## Verification Methods
    Support multiple identifier types:
    - `credential_id` - UUID of the credential  
    - `tx_hash` - Blockchain transaction hash
    - `ipfs_cid` - IPFS Content Identifier
    
    **Note**: QR codes are NOT sent to the backend. They are generated on the frontend
    and contain a URL (e.g., `https://example.com/verify?credential_id=xxx&tx_hash=yyy&ipfs_cid=zzz`)
    that opens the verification page with fields auto-filled.
    
    ## Verification Process
    1. Fetch credential from database
    2. Reconstruct canonical JSON
    3. Recompute SHA256 hash
    4. Compare with stored data_hash
    5. Verify blockchain transaction
    6. Verify IPFS CID (if provided)
    
    ## Result
    Returns `VALID` or `INVALID` with verification details
    
  version: 1.0.0
  contact:
    name: MicroMerit Portal Team
    email: support@micromerit.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.micromerit.com/api
    description: Production server

tags:
  - name: Credential Verification
    description: Verify credential authenticity

paths:
  /credentials/verify:
    post:
      tags: [Credential Verification]
      summary: Verify a credential
      description: |
        Verify the authenticity of a credential using any of the supported identifiers.
        
        **Public Endpoint**: No authentication required
        
        **Supported Identifiers** (provide exactly one):
        - `credential_id` - UUID of the credential
        - `tx_hash` - Blockchain transaction hash  
        - `ipfs_cid` - IPFS CID of the certificate
        
        **Verification Checks**:
        - Hash integrity (recompute SHA256 and compare)
        - Blockchain transaction verification
        - IPFS CID matching (if provided)
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                credential_id:
                  type: string
                  format: uuid
                  example: "123e4567-e89b-12d3-a456-426614174000"
                  description: Unique credential identifier
                tx_hash:
                  type: string
                  example: "0x123e4567e89b12d3a456426614174000"
                  description: Blockchain transaction hash
                 ipfs_cid:
                  type: string
                  example: "QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
                  description: IPFS Content Identifier
              minProperties: 1
              maxProperties: 1
            examples:
              by_credential_id:
                summary: Verify by credential ID
                value:
                  credential_id: "123e4567-e89b-12d3-a456-426614174000"
              by_tx_hash:
                summary: Verify by blockchain transaction hash
                value:
                  tx_hash: "0x123e4567e89b12d3a456426614174000"
              by_ipfs_cid:
                summary: Verify by IPFS CID
                value:
                  ipfs_cid: "QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
      
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/ValidCredential'
                      - $ref: '#/components/schemas/InvalidCredential'
              examples:
                valid_credential:
                  summary: Valid credential
                  value:
                    success: true
                    message: Credential verified successfully
                    data:
                      status: VALID
                      credential:
                        credential_id: "123e4567-e89b-12d3-a456-426614174000"
                        learner:
                          id: 42
                          name: "John Doe"
                          email: "learner@example.com"
                        learner_email: "learner@example.com"
                        issuer:
                          id: 1
                          name: "Example University"
                          type: "university"
                          website_url: "https://example.edu"
                        certificate_title: "Certificate of Completion - Web Development"
                        issued_at: "2024-01-15T10:00:00.000Z"
                        ipfs_cid: "QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
                        pdf_url: "https://ipfs.filebase.io/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG"
                        tx_hash: "0x123e4567e89b12d3a456426614174000"
                        data_hash: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
                        status: "issued"
                      verified_fields:
                        hash_match: true
                        blockchain_verified: true
                        ipfs_cid_match: true
                
                invalid_credential:
                  summary: Invalid credential
                  value:
                    success: true
                    message: Credential verification failed
                    data:
                      status: INVALID
                      reason: "Hash mismatch"
                      verified_fields:
                        hash_match: false
                        blockchain_verified: true
                        ipfs_cid_match: true
        
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: At least one identifier is required
                error: VALIDATION_ERROR
                statusCode: 400
        
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Credential not found
                error: CREDENTIAL_NOT_FOUND
                statusCode: 404
        
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Failed to verify credential
                error: Internal server error
                statusCode: 500

components:
  schemas:
    ValidCredential:
      type: object
      properties:
        status:
          type: string
          enum: [VALID]
        credential:
          type: object
          properties:
            credential_id:
              type: string
              format: uuid
            learner:
              type: object
              nullable: true
              properties:
                id:
                  type: integer
                name:
                  type: string
                email:
                  type: string
            learner_email:
              type: string
            issuer:
              type: object
              properties:
                id:
                  type: integer
                name:
                  type: string
                type:
                  type: string
                website_url:
                  type: string
            certificate_title:
              type: string
            issued_at:
              type: string
              format: date-time
            ipfs_cid:
              type: string
            pdf_url:
              type: string
              format: uri
            tx_hash:
              type: string
            data_hash:
              type: string
            status:
              type: string
            metadata:
              type: object
        verified_fields:
          type: object
          properties:
            hash_match:
              type: boolean
            blockchain_verified:
              type: boolean
            ipfs_cid_match:
              type: boolean
    
    InvalidCredential:
      type: object
      properties:
        status:
          type: string
          enum: [INVALID]
        reason:
          type: string
        verified_fields:
          type: object
          properties:
            hash_match:
              type: boolean
            blockchain_verified:
              type: boolean
            ipfs_cid_match:
              type: boolean
    
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
        statusCode:
          type: integer
