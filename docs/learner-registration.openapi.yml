openapi: 3.0.3
info:
  title: MicroMerit Portal - Learner Registration API
  description: |
    Three-step learner registration module with OTP verification via email or SMS.
    
    ## Registration Flow
    1. **Start Registration**: Initiate registration with email OR phone number
    2. **Verify OTP**: Verify the OTP sent via email/SMS
    3. **Complete Registration**: Finalize registration with password and profile details
    
    ## Features
    - OTP verification via email (Nodemailer) or SMS (Twilio)
    - Session-based registration with expiry (10 minutes default)
    - Duplicate email/phone prevention
    - Support for OAuth registration (password optional)
  version: 1.0.0
  contact:
    name: MicroMerit Portal Team
    email: support@micromerit.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.micromerit.com/api
    description: Production server

tags:
  - name: Registration
    description: Three-step learner registration with OTP verification
  - name: Email Management
    description: Add and verify additional emails to learner account

paths:
  /auth/learner/start-register:
    post:
      tags:
        - Registration
      summary: Start registration (Step 1)
      description: |
        Initiate the registration process by providing email OR phone number.
        An OTP will be sent to the provided contact method.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: learner@example.com
                  description: Email address (optional, but either email or phone is required)
                phone:
                  type: string
                  pattern: '^\+?[1-9]\d{1,14}$'
                  maxLength: 15
                  example: '+1234567890'
                  description: Phone number (optional, but either email or phone is required)
              description: Either email OR phone is required
      responses:
        '200':
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: OTP sent to your email
                  data:
                    type: object
                    properties:
                      sessionId:
                        type: string
                        format: uuid
                        example: 123e4567-e89b-12d3-a456-426614174000
                      message:
                        type: string
                        example: OTP sent to email
                      expiresAt:
                        type: string
                        format: date-time
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: Email or phone already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                email_exists:
                  summary: Email already in use
                  value:
                    success: false
                    message: Email already registered
                    error: EMAIL_ALREADY_REGISTERED
                    statusCode: 409
                phone_exists:
                  summary: Phone number already in use
                  value:
                    success: false
                    message: Phone number already registered
                    error: PHONE_ALREADY_REGISTERED
                    statusCode: 409
        '429':
          $ref: '#/components/responses/RateLimitError'

  /auth/learner/verify-otp:
    post:
      tags:
        - Registration
      summary: Verify OTP (Step 2)
      description: |
        Verify the OTP sent to email or phone number.
        The session must be verified before completing registration.
        Returns a temporary token for step 3.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - otp
              properties:
                sessionId:
                  type: string
                  format: uuid
                  example: 123e4567-e89b-12d3-a456-426614174000
                otp:
                  type: string
                  length: 6
                  pattern: '^\d{6}$'
                  example: '123456'
      responses:
        '200':
          description: OTP verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: OTP verified successfully
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: OTP verified successfully
                      tempToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                        description: |
                          **Temporary registration token - IMPORTANT**
                          
                          Use this token for Step 3 (complete-register):
                          - Valid for: 15 minutes
                          - Usage: Add to Authorization header as `Bearer <token>`
                          - Required for: POST /auth/learner/complete-register
                          - Token type: Contains 'registration' type and sessionId
                          
                          Example usage:
                          ```
                          Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                          ```
        '400':
          description: Invalid OTP or session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_otp:
                  summary: Incorrect OTP code
                  value:
                    success: false
                    message: Invalid OTP
                    error: INVALID_OTP
                    statusCode: 400
                otp_expired:
                  summary: OTP expired (>10 minutes)
                  value:
                    success: false
                    message: OTP expired
                    error: OTP_EXPIRED
                    statusCode: 400
                already_verified:
                  summary: Session already verified
                  value:
                    success: false
                    message: Session already verified
                    error: SESSION_ALREADY_VERIFIED
                    statusCode: 400
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Invalid session ID
                error: SESSION_NOT_FOUND
                statusCode: 404

  /auth/learner/complete-register:
    post:
      tags:
        - Registration
      summary: Complete registration (Step 3)
      description: |
        Complete the registration process after OTP verification.
        Creates the learner account and returns JWT tokens.
        
        **IMPORTANT - Authentication Required**: 
        This endpoint requires a temporary token obtained from Step 2 (verify-otp).
        The temporary token must be sent in the Authorization header as a Bearer token.
        
        **Token Details**:
        - Obtained from: POST /auth/learner/verify-otp (Step 2)
        - Valid for: 15 minutes
        - Format: `Authorization: Bearer <tempToken>`
        - Token type: Must be 'registration' type
        
        **Password Note**: Password is optional for OAuth-based registrations.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 255
                  example: John Doe
                password:
                  type: string
                  minLength: 8
                  maxLength: 100
                  example: SecurePass123!
                  description: Optional for OAuth registrations
                profilePhotoUrl:
                  type: string
                  format: uri
                  example: https://example.com/photo.jpg
                  description: Profile photo URL (optional)
      responses:
        '201':
          description: Registration completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Registration completed successfully
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Registration completed successfully
                      learner:
                        $ref: '#/components/schemas/LearnerProfile'
                      accessToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      refreshToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Invalid session or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                session_not_verified:
                  summary: OTP not verified yet
                  value:
                    success: false
                    message: Session not verified
                    error: SESSION_NOT_VERIFIED
                    statusCode: 400
                session_expired:
                  summary: Session expired (>10 minutes from OTP send)
                  value:
                    success: false
                    message: Session expired
                    error: SESSION_EXPIRED
                    statusCode: 400
                validation_error:
                  summary: Field validation failed
                  value:
                    success: false
                    message: Validation error
                    errors:
                      - field: name
                        message: Name is required
                    statusCode: 400
        '401':
          description: Missing or invalid temporary token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_token:
                  summary: No token provided
                  value:
                    success: false
                    message: Temporary token required
                    error: TOKEN_REQUIRED
                    statusCode: 401
                invalid_token_type:
                  summary: Wrong token type
                  value:
                    success: false
                    message: Invalid token type
                    error: INVALID_TOKEN_TYPE
                    statusCode: 401
                expired_token:
                  summary: Token expired (>15 minutes)
                  value:
                    success: false
                    message: Authentication token has expired
                    error: TOKEN_EXPIRED
                    statusCode: 401
                invalid_token:
                  summary: Malformed or invalid token
                  value:
                    success: false
                    message: Invalid authentication token
                    error: INVALID_TOKEN
                    statusCode: 401
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Invalid session ID
                error: SESSION_NOT_FOUND
                statusCode: 404

  /auth/learner/add-email/request:
    post:
      tags:
        - Email Management
      summary: Request to add email (Step 1)
      description: |
        Send OTP to add a new email address to learner's other_emails list.
        
        **IMPORTANT - Authentication Required**: 
        This endpoint requires authentication. The learner must be logged in.
        
        **Requirements**:
        - Email must not already be registered as primary email for any user
        - Email must not already be in learner's other_emails list
        - One email can be added at a time
        - Each addition requires OTP verification
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: alternate@example.com
                  description: New email address to add
      responses:
        '200':
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: OTP sent successfully
                  data:
                    type: object
                    properties:
                      sessionId:
                        type: string
                        format: uuid
                        example: 123e4567-e89b-12d3-a456-426614174001
                      message:
                        type: string
                        example: OTP sent to email
                      expiresAt:
                        type: string
                        format: date-time
        '400':
          description: Invalid request or email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                email_registered:
                  summary: Email already registered
                  value:
                    success: false
                    message: Email is already registered
                    statusCode: 400
                email_already_added:
                  summary: Email already in other_emails
                  value:
                    success: false
                    message: Email is already added to your account
                    statusCode: 400
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /auth/learner/add-email/verify:
    post:
      tags:
        - Email Management
      summary: Verify OTP and add email (Step 2)
      description: |
        Verify the OTP sent to email and add it to learner's other_emails list.
        
        **IMPORTANT - Authentication Required**: 
        This endpoint requires authentication. The learner must be logged in.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - otp
              properties:
                sessionId:
                  type: string
                  format: uuid
                  example: 123e4567-e89b-12d3-a456-426614174001
                otp:
                  type: string
                  length: 6
                  pattern: '^\d{6}$'
                  example: '123456'
      responses:
        '200':
          description: Email added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Email added successfully
                  data:
                    type: object
                    properties:
                      email:
                        type: string
                        format: email
                        example: alternate@example.com
                      message:
                        type: string
                        example: Email added successfully
        '400':
          description: Invalid OTP or session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_otp:
                  summary: Incorrect OTP code
                  value:
                    success: false
                    message: Invalid OTP
                    statusCode: 400
                otp_expired:
                  summary: OTP expired (>10 minutes)
                  value:
                    success: false
                    message: OTP expired
                    statusCode: 400
                already_verified:
                  summary: Session already verified
                  value:
                    success: false
                    message: Session already verified
                    statusCode: 400
                unauthorized_session:
                  summary: Session doesn't belong to learner
                  value:
                    success: false
                    message: Unauthorized access to session
                    statusCode: 400
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Invalid session ID
                statusCode: 404

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        - For step 3 (complete-register): Temporary JWT token from verify-otp step (valid for 15 minutes)
        - For email management: Standard JWT access token from login

  schemas:
    LearnerProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174002
        email:
          type: string
          format: email
          nullable: true
          example: learner@example.com
        phone:
          type: string
          nullable: true
          example: '+1234567890'
        profileUrl:
          type: string
          nullable: true
          format: uri
        otherEmails:
          type: array
          items:
            type: string
            format: email
        status:
          type: string
          enum: [active, suspended]
          example: active
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: An error occurred
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Validation error
            errors:
              - field: email
                message: Invalid email format

    UnauthorizedError:
      description: Authentication failed or token required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: User not authenticated
            statusCode: 401

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Registration session not found

    RateLimitError:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Too many requests. Please try again later.
