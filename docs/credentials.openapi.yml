openapi: 3.0.3
info:
  title: MicroMerit Portal - Credential Management API
  description: |
    Complete credential lifecycle management system for digital certificates.
    
    ## Features
    - **Issue Credentials**: Issuers can issue credentials to learners
    - **Claim Credentials**: Learners can claim issued credentials
    - **Revoke Credentials**: Issuers can revoke credentials with reason
    - **Verify Credentials**: Public verification by credential UID
    - **Statistics**: Get credential statistics by issuer or learner
    
    ## Credential States
    - `issued`: Credential issued but not yet claimed by learner
    - `claimed`: Credential claimed and owned by learner
    - `revoked`: Credential revoked by issuer (invalid)
    
    ## Integration
    - Links to `blockchain_record` table for blockchain hash storage
    - Links to `pdf_certificate` table for certificate generation
  version: 1.0.0
  contact:
    name: MicroMerit Portal Team
    email: support@micromerit.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.micromerit.com/api
    description: Production server

tags:
  - name: Issuer Credentials
    description: Credential operations for issuers
  - name: Learner Credentials
    description: Credential operations for learners
  - name: Public Verification
    description: Public credential verification

paths:
  /credentials/issue:
    post:
      tags:
        - Issuer Credentials
      summary: Issue a new credential
      description: |
        Issue a credential to a learner. Issuer must be authenticated and approved.
        The credential is created with `issued` status.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credentialUid
                - metadata
              properties:
                learnerEmail:
                  type: string
                  format: email
                  example: learner@example.com
                  description: Learner's email (optional, but either learnerEmail or learnerPhone is required)
                learnerPhone:
                  type: string
                  example: '+1234567890'
                  description: Learner's phone number (optional, but either learnerEmail or learnerPhone is required)
                credentialUid:
                  type: string
                  minLength: 1
                  example: CRED-550e8400-e29b-41d4-a716-446655440000
                  description: Unique credential identifier
                metadata:
                  type: object
                  example:
                    course_name: Web Development Bootcamp
                    grade: A+
                    completion_date: '2024-01-15'
                    duration: 12 weeks
                  description: Additional credential data (JSON object)
              description: Either learnerEmail or learnerPhone must be provided
      responses:
        '201':
          description: Credential issued successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credential issued successfully
                  data:
                    $ref: '#/components/schemas/Credential'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Learner not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Learner not found

  /credentials/claim:
    post:
      tags:
        - Learner Credentials
      summary: Claim a credential
      description: |
        Claim a credential that was issued to you. Changes status from `issued` to `claimed`.
        Cannot claim a credential that's already claimed or revoked.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credentialUid
              properties:
                credentialUid:
                  type: string
                  minLength: 1
                  example: CRED-550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Credential claimed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credential claimed successfully
                  data:
                    $ref: '#/components/schemas/Credential'
        '400':
          description: Cannot claim credential
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                already_claimed:
                  value:
                    success: false
                    message: Credential has already been claimed
                revoked:
                  value:
                    success: false
                    message: Cannot claim revoked credential
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /credentials/revoke:
    post:
      tags:
        - Issuer Credentials
      summary: Revoke a credential
      description: |
        Revoke a credential. Only the issuer who created the credential can revoke it.
        A reason can be provided for the revocation.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credentialUid
              properties:
                credentialUid:
                  type: string
                  minLength: 1
                  example: CRED-550e8400-e29b-41d4-a716-446655440000
                reason:
                  type: string
                  maxLength: 500
                  example: Certificate issued in error
                  description: Reason for revocation (optional)
      responses:
        '200':
          description: Credential revoked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credential revoked successfully
                  data:
                    $ref: '#/components/schemas/Credential'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Not authorized to revoke this credential
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: You are not authorized to revoke this credential
        '404':
          $ref: '#/components/responses/NotFoundError'

  /credentials/learner/my-credentials:
    get:
      tags:
        - Learner Credentials
      summary: Get learner's credentials
      description: Get all credentials for the authenticated learner
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [issued, claimed, revoked]
          description: Filter by credential status (optional)
      responses:
        '200':
          description: Credentials retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credentials retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Credential'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /credentials/issuer/my-credentials:
    get:
      tags:
        - Issuer Credentials
      summary: Get issuer's credentials
      description: Get all credentials issued by the authenticated issuer
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [issued, claimed, revoked]
          description: Filter by credential status (optional)
      responses:
        '200':
          description: Credentials retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credentials retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Credential'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /credentials/generate-uid:
    get:
      tags:
        - Issuer Credentials
      summary: Generate credential UID
      description: Generate a unique credential identifier for creating new credentials
      security:
        - BearerAuth: []
      responses:
        '200':
          description: UID generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: UID generated successfully
                  data:
                    type: object
                    properties:
                      credentialUid:
                        type: string
                        example: CRED-550e8400-e29b-41d4-a716-446655440000
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /credentials/{credentialUid}:
    get:
      tags:
        - Public Verification
      summary: Get credential details
      description: |
        Publicly get credential details by its UID. No authentication required.
        Returns credential details including status, issuer, and blockchain information.
      parameters:
        - name: credentialUid
          in: path
          required: true
          schema:
            type: string
          example: CRED-550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Credential retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credential retrieved successfully
                  data:
                    $ref: '#/components/schemas/Credential'
        '404':
          $ref: '#/components/responses/NotFoundError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from login

  schemas:
    Credential:
      type: object
      properties:
        id:
          type: integer
          example: 1
        credential_uid:
          type: string
          example: CRED-550e8400-e29b-41d4-a716-446655440000
          description: Unique credential identifier
        issuer_id:
          type: integer
          example: 1
        learner_id:
          type: integer
          nullable: true
          example: 5
        credential_type:
          type: string
          example: Course Completion Certificate
        metadata:
          type: object
          example:
            course_name: Web Development Bootcamp
            grade: A+
            completion_date: '2024-01-15'
          description: Additional credential data
        status:
          type: string
          enum: [issued, claimed, revoked]
          example: claimed
        revocation_reason:
          type: string
          nullable: true
          example: null
        issued_at:
          type: string
          format: date-time
        claimed_at:
          type: string
          format: date-time
          nullable: true
        revoked_at:
          type: string
          format: date-time
          nullable: true
        issuer:
          type: object
          properties:
            id:
              type: integer
            organization_name:
              type: string
              example: Tech University
            logo_url:
              type: string
              nullable: true
        learner:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
              example: John Doe
            email:
              type: string
              nullable: true
        blockchain_record:
          type: object
          nullable: true
          properties:
            transaction_hash:
              type: string
              example: 0xabc123...
            blockchain_network:
              type: string
              example: Ethereum
            recorded_at:
              type: string
              format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: An error occurred
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Validation error
            errors:
              - field: credential_type
                message: Credential type is required

    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Authentication required

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Credential not found
