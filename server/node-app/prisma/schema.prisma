generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model issuer {
  id                         Int              @id @default(autoincrement())
  name                       String
  official_domain            String?
  website_url                String?
  type                       String
  email                      String           @unique
  phone                      String?
  password_hash              String?
  contact_person_name        String?
  contact_person_designation String?
  address                    String?
  kyc_document_url           String?
  logo_url                   String?
  status                     String           @default("pending")
  approved_at                DateTime?
  rejected_reason            String?
  is_blocked                 Boolean          @default(false)
  blocked_reason             String?
  created_at                 DateTime         @default(now())
  
  // External credential sync fields
  registry_id                String?          // External provider ID
  last_sync_at               DateTime?        // Last credential sync timestamp
  accept_external            Boolean          @default(true)  // Accept external credentials
  reissue_local_vc           Boolean          @default(false) // Re-issue as local VC
  
  credentials                Credential[]
  apiKeys                    issuer_api_key[]
  publicKeys                 IssuerPublicKeys[]

  @@index([registry_id])
}

model issuer_api_key {
  id                    Int       @id @default(autoincrement())
  issuer_id             Int
  name                  String
  api_key               String    @unique
  active                Boolean   @default(true)
  revoked_reason        String?
  expires_at            DateTime?
  last_used_at          DateTime?
  usage_count           Int       @default(0)
  rate_limit_per_minute Int       @default(60)
  allowed_ips           String?
  created_at            DateTime  @default(now())
  issuer                issuer    @relation(fields: [issuer_id], references: [id])
}

model learner {
  id                     Int          @id @default(autoincrement())
  email                  String?      @unique
  phone                  String?      @unique
  hashed_password        String?
  profileFolder          String?
  profileUrl             String?
  external_digilocker_id String?
  status                 String       @default("active")
  other_emails           String[]
  created_at             DateTime     @default(now())
  dob                    DateTime?
  gender                 String?
  name                   String?
  credentials            Credential[]
  roadmap                LearnerRoadmap?
  skillProfile           LearnerSkillProfile?
}

model admin {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  created_at    DateTime @default(now())
}

model verification_session {
  id           String    @id @default(uuid())
  session_type String
  learner_id   Int?
  issuer_id    Int?
  employer_id  Int?
  email        String?
  phone        String?
  contact_type String?
  otp_hash     String
  is_verified  Boolean   @default(false)
  verified_at  DateTime?
  metadata     Json?
  expires_at   DateTime
  created_at   DateTime  @default(now())

  @@index([session_type])
  @@index([learner_id])
  @@index([issuer_id])
  @@index([employer_id])
  @@index([email])
  @@index([phone])
  @@index([expires_at])
}

model Credential {
  id                String   @id @default(uuid())
  credential_id     String   @unique
  learner_id        Int?
  learner_email     String
  issuer_id         Int
  certificate_title String
  issued_at         DateTime
  ipfs_cid          String?
  pdf_url           String?
  tx_hash           String?
  data_hash         String
  metadata          Json
  status            String   @default("issued")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // External credential fields
  is_external              Boolean  @default(false)
  provider_credential_id   String?  // Original ID from external provider
  signature_verified       Boolean  @default(false)
  verification_method      String?  // JWS, HMAC, PDF_DSC, etc.
  encrypted_raw_payload    String?  // Encrypted original signed payload
  match_confidence         Float?   // 0.0 to 1.0
  match_type               String?  // email, phone, fuzzy, etc.
  processed_at             DateTime?
  
  issuer            issuer   @relation(fields: [issuer_id], references: [id])
  learner           learner? @relation(fields: [learner_id], references: [id])

  @@index([credential_id])
  @@index([issuer_id])
  @@index([learner_id])
  @@index([learner_email])
  @@index([ipfs_cid])
  @@index([tx_hash])
  @@index([status])
  @@index([is_external])
  @@index([provider_credential_id])

  @@index([metadata(ops: JsonbPathOps)], type: Gin) // GIN index for JSON queries (skills/keywords search)
  @@index([certificate_title])
}

model SkillKnowledgeBase {
  id              Int      @id @default(autoincrement())
  qp_code         String?
  nos_code        String?
  job_role        String?
  nsqf_level      Int?
  sector          String?
  title           String?
  description     String?
  skill_text      String?
  keywords        String[]
  source_type     String   // "QP" | "NOS" | "Skill"
  created_at      DateTime @default(now())

  @@index([qp_code])
  @@index([nos_code])
  @@index([nsqf_level])
}

model LearnerRoadmap {
  id         Int      @id @default(autoincrement())
  learner_id Int      @unique
  data       Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  learner    learner  @relation(fields: [learner_id], references: [id])
}

model LearnerSkillProfile {
  id         Int      @id @default(autoincrement())
  learner_id Int      @unique
  data       Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  learner    learner  @relation(fields: [learner_id], references: [id])
}

model employer {
  id                Int       @id @default(autoincrement())
  company_name      String
  company_website   String?
  company_address   String?
  industry_type     String?
  company_size      String?
  contact_person    String?
  email             String      @unique
  phone             String?
  password_hash     String
  company_doc_url   String?      // Uploaded proof document - made optional for initial flexibility or filebase upload
  status            String      @default("pending") // pending | approved | rejected
  approved_at       DateTime?
  rejected_reason   String?
  created_at        DateTime    @default(now())
  activity_logs     employer_activity_log[]
}

model employer_activity_log {
  id             Int       @id @default(autoincrement())
  employer_id    Int
  credential_id  String?
  activity_type  String     // "verify" | "bulk_verify" | "search"
  details        Json?
  created_at     DateTime   @default(now())

  employer       employer @relation(fields: [employer_id], references: [id])
}

// =====================================
// External Credential Sync Tables
// =====================================

// Cached JWKS for issuers (for signature verification)
model IssuerPublicKeys {
  id               Int      @id @default(autoincrement())
  issuer_id        Int
  jwk_set_url      String
  cached_jwks      Json     // Cached JWKS document
  last_fetched_at  DateTime @default(now())
  issuer           issuer   @relation(fields: [issuer_id], references: [id])

  @@unique([issuer_id, jwk_set_url])
  @@index([issuer_id])
}

// Credentials imported from external sources (NSDC, DigiLocker)
// Idempotency tracking for processed jobs
model ProcessedJob {
  idempotency_key String   @id
  processed_at    DateTime @default(now())

  @@index([processed_at])
}

// Dead Letter Queue for failed jobs
model DLQ {
  id         String   @id @default(uuid())
  job_type   String              // Queue type
  job_id     String              // Original job ID
  reason     String              // Failure reason
  attempts   Int      @default(0)
  payload    Json                // Job payload for retry
  created_at DateTime @default(now())

  @@index([job_type])
  @@index([created_at])
}
