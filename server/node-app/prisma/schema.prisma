generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model issuer {
  id                         Int              @id @default(autoincrement())
  name                       String
  official_domain            String?
  website_url                String?
  type                       String
  email                      String           @unique
  phone                      String?
  password_hash              String?
  contact_person_name        String?
  contact_person_designation String?
  address                    String?
  kyc_document_url           String?
  logo_url                   String?
  status                     String           @default("pending")
  approved_at                DateTime?
  rejected_reason            String?
  is_blocked                 Boolean          @default(false)
  blocked_reason             String?
  created_at                 DateTime         @default(now())
  credentials                Credential[]
  apiKeys                    issuer_api_key[]
  bulkUploadBatches          BulkUploadBatch[]
}

model issuer_api_key {
  id                    Int       @id @default(autoincrement())
  issuer_id             Int
  name                  String
  api_key               String    @unique
  active                Boolean   @default(true)
  revoked_reason        String?
  expires_at            DateTime?
  last_used_at          DateTime?
  usage_count           Int       @default(0)
  rate_limit_per_minute Int       @default(60)
  allowed_ips           String?
  created_at            DateTime  @default(now())
  issuer                issuer    @relation(fields: [issuer_id], references: [id])
}

model learner {
  id                     Int                  @id @default(autoincrement())
  name                   String?
  email                  String?              @unique
  phone                  String?              @unique
  hashed_password        String?
  profileFolder          String?
  profileUrl             String?
  external_digilocker_id String?
  status                 String               @default("active")
  other_emails           String[]
  dob                    DateTime?
  gender                 String?
  created_at             DateTime             @default(now())
  credentials            Credential[]
  roadmap                LearnerRoadmap?
  skillProfile           LearnerSkillProfile?
}

model admin {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  created_at    DateTime @default(now())
}

model verification_session {
  id           String    @id @default(uuid())
  session_type String
  learner_id   Int?
  issuer_id    Int?
  email        String?
  phone        String?
  contact_type String?
  otp_hash     String
  is_verified  Boolean   @default(false)
  verified_at  DateTime?
  metadata     Json?
  expires_at   DateTime
  created_at   DateTime  @default(now())
  employer_id  Int?

  @@index([session_type])
  @@index([learner_id])
  @@index([issuer_id])
  @@index([employer_id])
  @@index([email])
  @@index([phone])
  @@index([expires_at])
}

model Credential {
  id                String   @id @default(uuid())
  credential_id     String   @unique
  learner_id        Int?
  learner_email     String
  issuer_id         Int
  certificate_title String
  issued_at         DateTime
  ipfs_cid          String?
  pdf_url           String?
  tx_hash           String?
  data_hash         String
  metadata          Json
  status            String   @default("issued")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Bulk Upload fields
  batch_id          Int?
  original_file_url String?
  verified_pdf_url  String?
  blockchain_tx_hash String?

  awarding_bodies   Json?
  certificate_code  String?
  max_hr            Int?
  min_hr            Int?
  nsqf_level        Int?
  occupation        String?
  sector            String?
  tags              Json?
  issuer            issuer   @relation(fields: [issuer_id], references: [id])
  learner           learner? @relation(fields: [learner_id], references: [id])
  batch             BulkUploadBatch? @relation(fields: [batch_id], references: [id])

  @@index([credential_id])
  @@index([issuer_id])
  @@index([learner_id])
  @@index([learner_email])
  @@index([ipfs_cid])
  @@index([tx_hash])
  @@index([status])
  @@index([metadata(ops: JsonbPathOps)], type: Gin)
  @@index([certificate_title])
  @@index([certificate_code])
  @@index([nsqf_level])
  @@index([sector])
}

model SkillKnowledgeBase {
  id          Int      @id @default(autoincrement())
  qp_code     String?
  nos_code    String?
  job_role    String?
  nsqf_level  Int?
  sector      String?
  title       String?
  description           String?
  skill_text            String?
  keywords              String[]
  source_type           String
  created_at            DateTime  @default(now())

  // NQR Specific Fields
  max_notional_hours    String?
  min_notional_hours    String?
  version               String?
  originally_approved   DateTime?
  valid_till            DateTime?
  awarding_body         String?
  certifying_body       String?
  proposed_occupation   String?
  progression_pathways  String?
  qualification_type    String?
  adopted_qualification String?
  training_delivery_hours Json?

  @@index([qp_code])
  @@index([nos_code])
  @@index([nsqf_level])
}

model LearnerRoadmap {
  id         Int      @id @default(autoincrement())
  learner_id Int      @unique
  data       Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  learner    learner  @relation(fields: [learner_id], references: [id])
}

model LearnerSkillProfile {
  id         Int      @id @default(autoincrement())
  learner_id Int      @unique
  data       Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  learner    learner  @relation(fields: [learner_id], references: [id])
}

model employer {
  id              Int                     @id @default(autoincrement())
  company_name    String
  company_website String?
  company_address String?
  industry_type   String?
  company_size    String?
  contact_person  String?
  email           String                  @unique
  phone           String?
  password_hash   String
  status          String                  @default("active")
  approved_at     DateTime?
  rejected_reason String?
  created_at      DateTime                @default(now())
  pan_number      String?                 @unique
  activity_logs   employer_activity_log[]
}

model employer_activity_log {
  id            Int      @id @default(autoincrement())
  employer_id   Int
  credential_id String?
  activity_type String
  details       Json?
  created_at    DateTime @default(now())
  employer      employer @relation(fields: [employer_id], references: [id])
}

model BulkUploadBatch {
  id             Int       @id @default(autoincrement())
  issuer_id      Int
  status         String    @default("processing") // processing, completed, failed
  total_records  Int       @default(0)
  success_count  Int       @default(0)
  failed_count   Int       @default(0)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  
  issuer         issuer    @relation(fields: [issuer_id], references: [id])
  credentials    Credential[]
  errors         BulkUploadError[]
}

model BulkUploadError {
  id             Int             @id @default(autoincrement())
  batch_id       Int
  file_name      String?
  error_message  String
  created_at     DateTime        @default(now())
  
  batch          BulkUploadBatch @relation(fields: [batch_id], references: [id])
}
